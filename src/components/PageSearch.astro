---
// @ts-expect-error - Starlight internal component type may be unavailable
import Default from '@astrojs/starlight/components/Search.astro';
---

<div data-page-search>
  <button
    aria-label="Search"
    class="page-search-button"
    title="Search (Ctrl+K)"
    type="button"
  >
    <svg
      xmlns="http://www.w3.org/2000/svg"
      width="18"
      height="18"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
      stroke-linecap="round"
      stroke-linejoin="round"
    >
      <circle cx="11" cy="11" r="8"></circle>
      <path d="m21 21-4.35-4.35"></path>
    </svg>
    <span class="sr-only">Search</span>
  </button>

  <Default />
</div>

<style>
  :global([data-page-search] site-search button[data-open-modal]),
  :global([data-page-search] .sl-search-button) {
    position: absolute !important;
    width: 1px !important;
    height: 1px !important;
    padding: 0 !important;
    margin: -1px !important;
    overflow: hidden !important;
    clip: rect(0, 0, 0, 0) !important;
    white-space: nowrap !important;
    border: 0 !important;
    opacity: 0 !important;
    visibility: hidden !important;
    pointer-events: auto !important;
    z-index: -1 !important;
  }

  .page-search-button {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border-radius: var(--page-radius);
    background: var(--page-accent-light);
    border: none;
    color: var(--page-text-secondary);
    cursor: pointer;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
  }

  .page-search-button:hover {
    background: var(--page-neutral-200);
    color: var(--page-text);
    transform: translateY(-1px);
  }

  .page-search-button:focus-visible {
    outline: 2px solid var(--page-accent);
    outline-offset: 2px;
  }

  .page-search-button:active {
    transform: scale(0.95);
  }

  .page-search-button svg {
    width: 18px;
    height: 18px;
  }

  :global([data-theme='dark']) .page-search-button:hover {
    background: var(--page-neutral-800) !important;
    color: var(--page-text) !important;
  }

  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
  }

  @media (max-width: 768px) {
    .page-search-button {
      width: 40px;
      height: 40px;
    }

    .page-search-button svg {
      width: 18px;
      height: 18px;
    }
  }

  @media (max-width: 480px) {
    .page-search-button {
      width: 32px !important;
      height: 32px !important;
      min-width: 32px !important;
      min-height: 32px !important;
    }

    .page-search-button svg {
      width: 16px !important;
      height: 16px !important;
      min-width: 16px !important;
      min-height: 16px !important;
    }
  }

  [data-page-search] {
    display: contents;
  }
</style>

<script>
  import { pagefindUserConfig } from 'virtual:starlight/pagefind-config';

  const pageSearchInitKey = '__pageSearchDelegated';
  const pageSearchInitMapKey = '__pageSearchInitPromiseMap';

  function getSearchRoot(sourceButton) {
    const root = sourceButton?.closest('[data-page-search]');
    return root instanceof HTMLElement ? root : null;
  }

  function getSiteSearch(root) {
    const siteSearch = root?.querySelector('site-search');
    return siteSearch instanceof HTMLElement ? siteSearch : null;
  }

  function getSearchContainer(siteSearch) {
    const container = siteSearch?.querySelector('#starlight__search');
    return container instanceof HTMLElement ? container : null;
  }

  function getNativeSearchButton(root) {
    const nativeButton = root?.querySelector('site-search button[data-open-modal]');
    return nativeButton instanceof HTMLButtonElement ? nativeButton : null;
  }

  function getSearchDialog(root) {
    const dialog = root?.querySelector('site-search dialog');
    return dialog instanceof HTMLDialogElement ? dialog : null;
  }

  function getInitPromiseMap() {
    if (!(window[pageSearchInitMapKey] instanceof WeakMap)) {
      window[pageSearchInitMapKey] = new WeakMap();
    }
    return window[pageSearchInitMapKey];
  }

  async function ensurePagefindInitialized(root) {
    if (import.meta.env.DEV) return;

    const siteSearch = getSiteSearch(root);
    const container = getSearchContainer(siteSearch);
    if (!siteSearch || !container) return;

    if (
      container.dataset.pagefindInitialized === 'true' ||
      container.childElementCount > 0
    ) {
      container.dataset.pagefindInitialized = 'true';
      return;
    }

    const initMap = getInitPromiseMap();
    const inFlight = initMap.get(container);
    if (inFlight) {
      await inFlight;
      return;
    }

    const initPromise = (async () => {
      let translations = {};
      try {
        translations = JSON.parse(siteSearch.dataset.translations || '{}');
      } catch {
        translations = {};
      }

      const shouldStrip = siteSearch.dataset.stripTrailingSlash !== undefined;
      const stripTrailingSlash = (path) => path.replace(/(.)\/(#.*)?$/, '$1$2');
      const formatURL = shouldStrip ? stripTrailingSlash : (path) => path;

      try {
        // @ts-expect-error - @pagefind/default-ui has no bundled TS types for runtime import here.
        const { PagefindUI } = await import('@pagefind/default-ui');

        new PagefindUI({
          ...pagefindUserConfig,
          element: container,
          baseUrl: import.meta.env.BASE_URL,
          bundlePath: import.meta.env.BASE_URL.replace(/\/$/, '') + '/pagefind/',
          showImages: false,
          translations,
          showSubResults: true,
          processResult: (result) => {
            result.url = formatURL(result.url);
            result.sub_results = result.sub_results.map((subResult) => {
              subResult.url = formatURL(subResult.url);
              return subResult;
            });
          },
        });

        container.dataset.pagefindInitialized = 'true';
      } catch (error) {
        console.error('[page-search] Failed to initialize Pagefind UI:', error);
      }
    })();

    initMap.set(container, initPromise);
    await initPromise;
  }

  async function triggerSearch(sourceButton) {
    const root = getSearchRoot(sourceButton);
    if (!root) return;

    await ensurePagefindInitialized(root);

    const nativeButton = getNativeSearchButton(root);
    if (nativeButton && typeof nativeButton.click === 'function') {
      nativeButton.disabled = false;
      nativeButton.click();
      return;
    }

    const dialog = getSearchDialog(root);
    if (
      dialog instanceof HTMLDialogElement &&
      typeof dialog.showModal === 'function' &&
      !dialog.open
    ) {
      try {
        dialog.showModal();
        return;
      } catch {
        // ignore and fallback below
      }
    }
  }

  function closeStaleSearchDialogs() {
    document.querySelectorAll('site-search dialog[open]').forEach((dialog) => {
      if (dialog instanceof HTMLDialogElement) {
        try {
          dialog.close();
        } catch {
          // Ignore close errors from already-detached dialogs.
        }
      }
    });
    document.body.toggleAttribute('data-search-modal-open', false);
  }

  if (!window[pageSearchInitKey]) {
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!(target instanceof Element)) return;

      const pageSearchButton = target.closest('.page-search-button');
      if (!(pageSearchButton instanceof HTMLElement)) return;

      e.preventDefault();
      e.stopPropagation();
      void triggerSearch(pageSearchButton);
    });

    document.addEventListener('astro:before-swap', closeStaleSearchDialogs);

    window[pageSearchInitKey] = true;
  }
</script>
